{% extends "base.html" %}
{% block title %}Create Invoice · BV Management{% endblock %}

{% block content %}
  <div class="h1">Create Invoice</div>

  <form method="post" action="{{ url_for('create_invoice') }}" class="card section" id="invForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="customer_registration_id" id="customer_registration_id"
           value="{{ prefill.customer_registration_id if prefill else '' }}">

    <!-- Customer picker -->
    <div class="card" style="margin-bottom:12px; overflow:hidden">
      <div class="h2">Customer</div>
      <div class="row" style="gap:8px; flex-wrap:wrap; align-items:flex-end">
        <div style="min-width:260px; flex:2">
          <label>Search customer (name, email, company)</label>
          <input type="text" id="custSearch" placeholder="Start typing… (min 2 chars)">
        </div>
        <div class="mut" id="custSelected" style="min-height:1.5em">
          {% if prefill and prefill.customer_registration_id %}
            Selected: #{{ prefill.customer_registration_id }}
          {% endif %}
        </div>
        <div style="margin-left:auto">
          <button type="button" id="clearSelection" class="mut">Clear selection</button>
        </div>
      </div>

      <div id="custResults" class="results"></div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div><label>Issue date</label><input type="date" name="issue_date" required></div>
      <div><label>Supply date</label><input type="date" name="supply_date" required></div>
      <div><label>Due date</label><input type="date" name="due_date" required></div>
      <div><label>Currency</label><select name="currency"><option value="EUR" selected>EUR</option></select></div>
    </div>

    <div class="grid section" style="grid-template-columns:1fr 1fr">
      <div><label>Customer name</label>
        <input name="client_name" id="client_name" required
               value="{{ prefill.client_name if prefill else '' }}">
      </div>
      <div><label>Customer VAT (if reverse charge)</label>
        <input name="client_vat_number" id="client_vat_number" placeholder="EU VAT (BTW verlegd)"
               value="{{ prefill.client_vat_number if prefill else '' }}">
      </div>
      <div style="grid-column:1 / span 2">
        <label>Customer address</label>
        <textarea name="client_address" id="client_address" rows="2" required>{{ prefill.client_address if prefill else '' }}</textarea>
      </div>
      <div>
        <label>VAT scheme</label>
        <select name="vat_scheme" id="vat_scheme">
          <option value="STANDARD" selected>STANDARD (charge 21/9/0)</option>
          <option value="REVERSE_CHARGE_EU">Reverse charge (BTW verlegd)</option>
          <option value="ZERO_OUTSIDE_EU">0% export outside EU</option>
          <option value="EXEMPT">Exempt</option>
        </select>
      </div>
      <div><label>Notes</label><input name="notes" placeholder="e.g., BTW verlegd art. 12 Wet OB"></div>
    </div>

    <div class="h2 section">Lines</div>
    <div id="lines">
      <div class="row" style="gap:8px;align-items:center">
        <input name="line_desc" placeholder="Description" required style="flex:3">
        <input name="line_qty" type="number" step="0.01" placeholder="Qty" value="1" required style="flex:1">
        <input name="line_price" type="number" step="0.01" placeholder="Unit price" required style="flex:1">
        <select name="line_vat" class="line-vat" style="flex:1">
          <option value="21">21%</option><option value="9">9%</option><option value="0" selected>0%</option>
        </select>
        <button type="button" onclick="removeLine(this)">✕</button>
      </div>
    </div>
    <div class="row section"><button type="button" onclick="addLine()">+ Add line</button></div>

    <div class="row right section"><button>Create Invoice</button></div>
  </form>

  <style>
    /* Customer results list */
    #custResults { margin-top:10px; display:grid; gap:8px; }
    .result-card { border:1px solid #e5e7eb; border-radius:8px; padding:10px; display:flex; align-items:center; gap:10px; }
    .result-main { min-width:0; flex:1; }
    .result-title { font-weight:600; overflow-wrap:anywhere; }
    .result-sub { color:#6b7280; font-size:12px; overflow-wrap:anywhere; }
    .result-actions { display:flex; gap:6px; }
  </style>
{% endblock %}

{% block scripts %}
<script>
  // ---------- VAT scheme toggle ----------
  const vatScheme = document.getElementById('vat_scheme');
  function syncVatOptions(){
    const rc = vatScheme.value === 'REVERSE_CHARGE_EU';
    const zero = vatScheme.value === 'ZERO_OUTSIDE_EU' || vatScheme.value === 'EXEMPT';
    document.querySelectorAll('.line-vat').forEach(sel => {
      if (rc || zero) { sel.value = '0'; sel.disabled = true; }
      else { sel.disabled = false; }
    });
  }
  if(vatScheme){ vatScheme.addEventListener('change', syncVatOptions); syncVatOptions(); }

  // ---------- Lines add/remove ----------
  function addLine(){
    const row = document.createElement('div');
    row.className = 'row'; row.style.gap='8px'; row.style.alignItems='center';
    row.innerHTML = `
      <input name="line_desc" placeholder="Description" required style="flex:3">
      <input name="line_qty" type="number" step="0.01" placeholder="Qty" value="1" required style="flex:1">
      <input name="line_price" type="number" step="0.01" placeholder="Unit price" required style="flex:1">
      <select name="line_vat" class="line-vat" style="flex:1">
        <option value="21">21%</option><option value="9">9%</option><option value="0" selected>0%</option>
      </select>
      <button type="button" onclick="removeLine(this)">✕</button>`;
    document.getElementById('lines').appendChild(row);
    syncVatOptions();
  }
  function removeLine(btn){
    const parent = btn.closest('.row');
    if(parent && document.querySelectorAll('#lines .row').length > 1){ parent.remove(); }
  }

  // ---------- Customer selector ----------
  const custSearch = document.getElementById('custSearch');
  const custResults = document.getElementById('custResults');
  const custSelected = document.getElementById('custSelected');
  const custIdField = document.getElementById('customer_registration_id');

  const f_name = document.getElementById('client_name');
  const f_vat  = document.getElementById('client_vat_number');
  const f_addr = document.getElementById('client_address');

  let debounceHandle = null;

  function clearResults(){
    custResults.innerHTML = '';
  }

  function setSelectedText(id, label){
    if(id){
      custSelected.textContent = `Selected: #${id} · ${label}`;
    } else {
      custSelected.textContent = '';
    }
  }

  function useCustomer(rec){
    // Fill the invoice header fields
    f_name.value = rec.client_name || '';
    f_vat.value  = rec.client_vat_number || '';
    f_addr.value = rec.client_address || '';
    // Store hidden id
    custIdField.value = rec.id || '';
    setSelectedText(rec.id, rec.label || '');
  }

  function renderResults(list){
    clearResults();
    list.forEach(rec => {
      const card = document.createElement('div');
      card.className = 'result-card';

      const main = document.createElement('div');
      main.className = 'result-main';

      const title = document.createElement('div');
      title.className = 'result-title';
      title.textContent = rec.label || '';
      const sub = document.createElement('div');
      sub.className = 'result-sub';
      sub.textContent = [rec.company, rec.email].filter(Boolean).join(' · ');

      main.appendChild(title); main.appendChild(sub);

      const actions = document.createElement('div');
      actions.className = 'result-actions';
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'Use this customer';
      btn.addEventListener('click', () => useCustomer(rec));
      actions.appendChild(btn);

      card.appendChild(main);
      card.appendChild(actions);
      custResults.appendChild(card);
    });
  }

  async function searchCustomers(q){
    try{
      const resp = await fetch(`{{ url_for('customers_lookup_api') }}?q=` + encodeURIComponent(q));
      const data = await resp.json();
      renderResults(data.results || []);
    } catch(e){
      clearResults();
    }
  }

  if(custSearch){
    custSearch.addEventListener('input', () => {
      const q = custSearch.value.trim();
      if(debounceHandle) clearTimeout(debounceHandle);
      if(q.length < 2){ clearResults(); return; }
      debounceHandle = setTimeout(() => searchCustomers(q), 250);
    });
  }

  document.getElementById('clearSelection').addEventListener('click', () => {
    custIdField.value = '';
    setSelectedText('', '');
  });
</script>
{% endblock %}
